---
title: "Activity 14: Statistical reasoning 6: generalized linear and multilevel models"
author: "Abbie & Gabe"
format:
 pdf: default
editor: visual
---

# 1. Generalized linear models

## 1.1 Introduction

```{r}
library(tidyverse) # For data wrangling
library(brms) # For stats
library(ggeffects) # for plotting model predictions
# Note: I needed to also install the `insight` and `see` packages to get `modelbased` to install properly; try that if you get similar error messages 
# install.packages('modelbased') # if you need to install this package
library(modelbased) # for plotting model predictions. supports the link scale (ggeffects does not)
# install.packages('faraway') # if you need to install this package
library(faraway) # For data on galapagos species richess
```

Let’s look at the (huge) variety of distribution families that are available to use:

```{r}
?brmsfamily
```

### Conceptual practice

For Q1.1a and b, consider the following response variables:

1.  Counts of Clarkia flowers in a meadow

2.  Whether or not a female elephant seal gives birth

3.  The percent cover of red algae in the intertidal

4.  Growth of a tree from one year to the next

5.  The spatial area of a forest in square meters

#### Q1.1a What values can each of the response variables take on?

1.  Counts of Clarkia flowers in a meadow

    *Positive real integers*

2.  Whether or not a female elephant seal gives birth

    *Binary– 0/1*

3.  The percent cover of red algae in the intertidal

    *Non negative– fractions*

4.  Growth of a tree from one year to the next

    *Positive, not bounded by an integer can be fraction*

5.  The spatial area of a forest in square meters

    *Positive, not bounded by an integer can be fraction*

#### Q1.1b Choose a distribution that fits each of the response variables

1.  Counts of Clarkia flowers in a meadow

    Poisson

2.  Whether or not a female elephant seal gives birth

    Binomial

3.  The percent cover of red algae in the intertidal

    Beta

4.  Growth of a tree from one year to the next

    Poisson

5.  The spatial area of a forest in square meters

    Poisson

#### Q1.2 Choose a distribution that fits your final project response variable

1.  Enzymatic activity is the response variable in Gabe's final project.
2.  The values cannot be lower than 0 and do not have to be whole numbers
3.  Therefore fits a poisson distribution.

## 1.2 GLM with a log link

### Explore the data

```{r}
# Read in the pre-stored data
data("gala")
# Check out the first 6 rows
head(gala)

```

```{r}
?gala
```

#### Q1.3 Plot a histogram of the response variable `Endemics`

```{r}
ggplot(gala, aes(x = Endemics)) +
  geom_histogram()
```

This does not look like a normal distribution. This looks quite skewed toward lower numbers of endemic species. There are no numbers below zero and numbers are all whole.

#### Q1.4 Plot Endemics \~ Elevation

```{r}
ggplot(gala, aes(y=Endemics, x= Elevation)) +
  geom_point()
```

### Run the model

```{r}
# Endemics ~ Elevation
m.elev <- 
  brm(data = gala, # Give the model the penguins data
      # Choose a poisson distribution - THIS IS THE NEW PART!
      family = poisson(link = "log"),
      # Specify the model here. 
      Endemics ~ 1 + Elevation,
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.elev")
```

```{r}
plot(m.elev)
```

```{r}
pairs(m.elev)
```

```{r}
summary(m.elev)
```

#### Q1.5 Evaluate the output

Looks like the model did not converge, the Rhat value is greater than 1.0. Chains are non overlapping and posterior distributions are not normally distributed.

#### Q1.6 Center the predictors

```{r}
#Adding in new column 
gala <- gala %>% 
  mutate(Elevation_ctr = Elevation - mean(Elevation))
```

```{r}
#New Model
m.elev2 <- 
  brm(data = gala,
      family = poisson(link = "log"),
      Endemics ~ 1 + Elevation_ctr,
      iter = 6000, warmup = 4000, chains = 4, cores = 4,
      file = "output/m.elev2")
```

```{r}
plot(m.elev2)
```

```{r}
summary(m.elev2)
print(m.elev2, digits = 4)
```

```{r}
pairs(m.elev2)
```

### Plot the posterior

```{r}
preds <- estimate_expectation(m.elev2, by = 'Elevation_ctr')
plot(preds, show_data = TRUE)
```

```{r}
predslog <- estimate_expectation(m.elev2, by = 'Elevation_ctr', predict = 'link')
plot(predslog)
```

### Interpreting link scale coefficients

```{r}
print(m.elev2, digits = 4)
```

Backtransform:

```{r}
exp(0.0013)
```

Interpret

```{r}
plot(preds, show_data = TRUE)
```

#### Q1.7 What is the percent change on the response scale?

1.  Number of Clarkias blooming as a function of temperature in Celsius: 1.09

    ```{r}
    exp(1.09)
    ```

    For every 1 degree increase in Celsius, there is a 2.97 times increase in number of Clarkias blooming as the previous degree.

2.  Density of sea urchins per square meter in a quadrat as a function of number of sea otters: -2.5

    ```{r}
    exp(-2.5)
    ```

    For every sea otter present, there is a 8.2085% decrease in sea urchins densities per square meter.

3.  Number of tomatoes per plant as a function of kg of fertilizer: 6.24

    ```{r}
    exp(6.24)
    ```

    For every kg of fertilizer, there is a 512.8 times increase in number of tomatoes per plant. (lol what?!)

### DIY: Run a model of non-endemic species \~ distance from Santa Cruz Island

#### Q1.8 Create a non-endemic column

New column

```{r}
gala <- gala %>% 
  mutate(non_Endemics = Species - Endemics)
```

Plot of non endemics

```{r}
ggplot(gala, aes(x= Scruz, y = non_Endemics)) +
  geom_point()
```

#### Q1.9 Run a model of non Endemics \~ distance from Santa Cruz Island

```{r}
m.non_endem <- 
  brm(data = gala,
      family = poisson(link = "log"),
      non_Endemics ~ 1 + Scruz,
      iter = 6000, warmup = 4000, chains = 4, cores = 4,
      file = "output/m.non_endem")
```

#### Q1.10 Evaluate the output

```{r}
summary(m.non_endem)
print(m.non_endem, digits = 4)
```

```{r}
plot(m.non_endem)

exp(-0.01)
```

Looks like the model ran correctly, Rhat is 1, the chains are overlapping, and the posterior distributions are normally distributed.

#### Q1.11 Interpret the output

1.  What is the effect of distance from Santa Cruz Island on number of non-endemic species? Report the a) original output on the log scale, b) your backtransformed value, and c) the percent change that this translates to. Describe the effect using the proper units.

a\) -0.01

b\)

```         
0.9900498
```

c\) For every 1 km distance from SC island, the amount of non-endemic species is changing at a rate of 0.99.

2.  Does it seem like the slope estimate is different from zero? Why?

    Yes, it does seem like the slope estimate is different from zero, but only barely because the compatibility intervals are only just outside of the range of zero.

#### Q1.12 Plot the posterior

Response scale

```{r}
preds_endem <- estimate_expectation(m.non_endem, by = 'Scruz')
plot(preds_endem, show_data = TRUE)
```

\
Log Scale

```{r}
preds_endemlog <- estimate_expectation(m.non_endem, by = 'Scruz', predict = 'link')
plot(preds_endemlog
    )
```

## 1.3 GLM with a logit link

### Bring in turtle data

```{r}
turtle <- faraway::turtle %>% 
  mutate(total_turtles = male + female,
         proportion_female = female/total_turtles)
```

```{r}
turtle %>% 
  ggplot(aes(x = temp, y = proportion_female)) +
  geom_point()
```

### Run model

```{r}
m.turt <- 
  brm(data = turtle, # Give the model the data
      # Choose a binomial distribution - THIS IS THE NEW PART!
      family = binomial(link = "logit"),
      # Specify the model here. 
      female | trials(total_turtles) ~ 1 + temp,
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 4000, warmup = 1000, chains = 4, cores = 4,
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.turt")
```

```{r}
summary(m.turt)
```

### Interpret model and plot predictions

```{r}
pred <- predict_response(m.turt, condition = c(total_turtles = 10))

plot(pred)
```

# 2. Multilevel models

### Conceptual practice

#### Q2.1 Fixed effects vs random effects

For the following variables in the model examples below, denote which variables are the fixed effects and which could be accounted for as random effects (some variables could be either, but consider then as being eligible to be random effects):

1.  Student high school graduation rates as a function of: parental income, state of residence, and school district

    Fixed effects: parental income, state of residence, school district

    Random Effects:

2.  Density of kelp as a function of: latitude, site, transect number, and density of sea urchins

    Fixed: density, latitude

    Random: site, transect number,

3.  Probability of whale giving birth as a function of: age, annual temperature, year, individual ID

    Fixed: Annual temperature, Age

    Random: Year, Individual ID

### Incorporate random effects

```{r}
pie_crab <- lterdatasampler::pie_crab %>% 
  mutate(site = as.factor(site))
```

```{r}
pie_crab %>% 
  ggplot(aes(x = air_temp, y = size)) +
  geom_point()
```

```{r}
m.watertemp <- 
  brm(data = pie_crab, # Give the model the penguins data
      # Use a gamma distribution
      family = Gamma(link = "log"),
      # Specify the model here. 
      size ~ 1 + water_temp,
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.watertemp")

print(m.watertemp, digits = 3)
```

```{r}
m.watertemp.site <- 
  brm(data = pie_crab, # Give the model the penguins data
      # Use a gamma distribution
      family = Gamma(link = "log"),
      # Specify the model here. 
      size ~ 1 + water_temp + (1|site),
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.watertemp.site")

print(m.watertemp.site, digits = 3)
```

#### Q2.2 What is the effect of water_temp on crab size on the response scale?

1.  What is the effect of water_temp on crab size? Report the a) original output on the log scale, b) your backtransformed value, and c) the percent change that this translates to. Describe the effect using the proper units.

    a\)

    ```         
    -0.039
    ```

    b\)

    ```{r}
    exp(-0.039 )
    ```

    c\) For every 1 degree increase in water temperature, there is a 0.96% mm increase in crab carapace size.

2.  Does it seem like the slope estimate is different from zero? Why?

    Yes, this is reasonably different from zero since the 95% compatibility intervals are outside of the bounds of zero.

#### Q2.3 Compare WAIC and PSIS of the two models

```{r}
#PSIS
loo(m.watertemp)
loo(m.watertemp.site)

#WAIC
waic(m.watertemp)
waic(m.watertemp.site)
```

With side included, the WAIC and PSIS values are lower, so this model is better.
